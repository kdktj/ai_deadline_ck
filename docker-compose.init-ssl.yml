# =============================================================================
# DOCKER COMPOSE - SSL INITIALIZATION ONLY
# =============================================================================
# Dùng để khởi tạo SSL certificate từ Let's Encrypt
# Chỉ chạy nginx với config tối thiểu cho ACME challenge
# =============================================================================

services:
  # NGINX - chỉ phục vụ ACME challenge
  nginx:
    image: nginx:alpine
    container_name: ai_deadline_nginx_init
    restart: "no"
    ports:
      - "80:80"
    volumes:
      - ./certbot/www:/var/www/certbot:ro
    command: |
      sh -c "
        echo 'server {
          listen 80;
          listen [::]:80;
          server_name ai-deadline.io.vn www.ai-deadline.io.vn api.ai-deadline.io.vn n8n.ai-deadline.io.vn;
          
          location /.well-known/acme-challenge/ {
            root /var/www/certbot;
          }
          
          location / {
            return 200 \"SSL initialization in progress...\";
            add_header Content-Type text/plain;
          }
        }' > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'
      "

  # Certbot for certificate request
  certbot:
    image: certbot/certbot
    container_name: ai_deadline_certbot_init
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
