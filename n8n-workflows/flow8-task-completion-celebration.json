{
  "name": "Flow 10 - Task Completion Celebration",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "n8n/task-completed",
        "responseMode": "lastNode",
        "options": {}
      },
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "task-completed-webhook"
    },
    {
      "parameters": {
        "url": "={{$env.BACKEND_API_URL}}/api/webhooks/n8n/task-owner-email/{{$json.body.task_id}}",
        "authentication": "none",
        "options": {}
      },
      "name": "HTTP: Get Task Owner Email",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [460, 300]
    },
    {
      "parameters": {
        "url": "={{$env.BACKEND_API_URL}}/api/webhooks/n8n/tasks",
        "authentication": "none",
        "options": {}
      },
      "name": "HTTP: Get All Tasks",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [680, 300]
    },
    {
      "parameters": {
        "functionCode": "// Prepare congratulation message and next task suggestions\nconst taskInfo = $node['HTTP: Get Task Owner Email'].json;\nconst tasksResponse = $input.first().json;\nconst allTasks = tasksResponse.tasks || [];\nconst webhookData = $node['Webhook Trigger'].json.body;\n\nconst ownerId = taskInfo.owner_id;\n\n// Get owner's remaining tasks\nconst ownerTasks = allTasks.filter(t => \n  t.owner_id === ownerId && t.status !== 'done'\n);\n\n// Sort by priority and deadline\nconst priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };\nownerTasks.sort((a, b) => {\n  const priorityDiff = (priorityOrder[a.priority] || 3) - (priorityOrder[b.priority] || 3);\n  if (priorityDiff !== 0) return priorityDiff;\n  \n  const deadlineA = a.deadline ? new Date(a.deadline) : new Date('2099-12-31');\n  const deadlineB = b.deadline ? new Date(b.deadline) : new Date('2099-12-31');\n  return deadlineA - deadlineB;\n});\n\nconst nextTasks = ownerTasks.slice(0, 3);\n\n// Calculate stats\nconst completedCount = allTasks.filter(t => t.owner_id === ownerId && t.status === 'done').length;\nconst totalCount = allTasks.filter(t => t.owner_id === ownerId).length;\nconst completionRate = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;\n\n// Build motivational message based on completion rate\nlet motivation = '';\nif (completionRate >= 90) {\n  motivation = 'üèÜ Xu·∫•t s·∫Øc! B·∫°n g·∫ßn nh∆∞ ho√†n th√†nh t·∫•t c·∫£!';\n} else if (completionRate >= 70) {\n  motivation = 'üåü Tuy·ªát v·ªùi! B·∫°n ƒëang l√†m r·∫•t t·ªët!';\n} else if (completionRate >= 50) {\n  motivation = 'üëç T·ªët l·∫Øm! Ti·∫øp t·ª•c duy tr√¨ nh√©!';\n} else {\n  motivation = 'üí™ Ti·∫øp t·ª•c c·ªë g·∫Øng! M·ªói b∆∞·ªõc nh·ªè ƒë·ªÅu quan tr·ªçng!';\n}\n\nreturn {\n  json: {\n    task_id: taskInfo.task_id,\n    task_name: taskInfo.task_name,\n    project_name: taskInfo.project_name,\n    owner_email: taskInfo.owner_email,\n    owner_name: taskInfo.owner_name,\n    completed_count: completedCount,\n    total_count: totalCount,\n    remaining_count: totalCount - completedCount,\n    completion_rate: completionRate,\n    motivation: motivation,\n    next_tasks: nextTasks,\n    actual_hours: webhookData.actual_hours || null\n  }\n};"
      },
      "name": "Function: Prepare Celebration Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.owner_email}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "name": "IF: Has Email",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "functionCode": "// Build next tasks HTML\nconst data = $input.first().json;\nconst nextTasks = data.next_tasks || [];\n\nconst nextTasksHtml = nextTasks.length > 0 \n  ? nextTasks.map((t, i) => {\n      const deadlineStr = t.deadline \n        ? new Date(t.deadline).toLocaleDateString('vi-VN')\n        : 'Ch∆∞a ƒë·∫∑t';\n      const priorityEmoji = {\n        critical: 'üî¥',\n        high: 'üü†',\n        medium: 'üü°',\n        low: 'üü¢'\n      }[t.priority] || '‚ö™';\n      \n      return `<div style=\"background: white; padding: 12px; border-radius: 8px; margin: 8px 0; border-left: 4px solid ${t.priority === 'critical' || t.priority === 'high' ? '#ef4444' : '#3b82f6'};\">\n        <strong>${i + 1}. ${t.name}</strong><br>\n        <small style=\"color: #666;\">${priorityEmoji} ${t.priority.toUpperCase()} ‚Ä¢ Deadline: ${deadlineStr} ‚Ä¢ Ti·∫øn ƒë·ªô: ${t.progress || 0}%</small>\n      </div>`;\n    }).join('')\n  : '<p style=\"color: #10b981;\">üéâ B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ tasks! Ngh·ªâ ng∆°i x·ª©ng ƒë√°ng nh√©!</p>';\n\nreturn {\n  json: {\n    ...data,\n    next_tasks_html: nextTasksHtml\n  }\n};"
      },
      "name": "Function: Format Email Content",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "fromEmail": "={{$env.EMAIL_FROM}}",
        "toEmail": "={{$json.owner_email}}",
        "subject": "üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh \"{{$json.task_name}}\"",
        "emailType": "html",
        "text": "=Xin ch√†o {{$json.owner_name}}!\n\nüéâ CH√öC M·ª™NG B·∫†N ƒê√É HO√ÄN TH√ÄNH TASK!\n\n‚úÖ Task: {{$json.task_name}}\nüìÅ D·ª± √°n: {{$json.project_name}}\n\nüìä TI·∫æN ƒê·ªò C·ª¶A B·∫†N:\n- ƒê√£ ho√†n th√†nh: {{$json.completed_count}}/{{$json.total_count}} tasks\n- T·ª∑ l·ªá: {{$json.completion_rate}}%\n- C√≤n l·∫°i: {{$json.remaining_count}} tasks\n\n{{$json.motivation}}\n\nüìã TASKS TI·∫æP THEO G·ª¢I √ù:\n(D·ª±a tr√™n ƒë·ªô ∆∞u ti√™n v√† deadline)\n\nTi·∫øp t·ª•c l√†m vi·ªác: http://localhost:5173/tasks\n\n---\nEmail t·ª± ƒë·ªông t·ª´ AI Deadline - C√¥ng c·ª• qu·∫£n l√Ω deadline C√Å NH√ÇN c·ªßa b·∫°n",
        "html": "=<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }\n    .celebration { font-size: 60px; margin-bottom: 10px; }\n    .content { background: #f9f9f9; padding: 25px; }\n    .completed-task { background: #ecfdf5; border: 2px solid #10b981; border-radius: 10px; padding: 20px; margin: 15px 0; text-align: center; }\n    .stats-row { display: flex; justify-content: space-around; background: white; border-radius: 10px; padding: 20px; margin: 15px 0; }\n    .stat { text-align: center; }\n    .stat-value { font-size: 28px; font-weight: bold; color: #10b981; }\n    .stat-label { font-size: 12px; color: #666; }\n    .motivation-box { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; padding: 15px; margin: 15px 0; text-align: center; font-size: 18px; }\n    .next-tasks { background: white; border-radius: 10px; padding: 20px; margin: 15px 0; }\n    .section-title { font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }\n    .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; background: #f9f9f9; border-radius: 0 0 10px 10px; }\n  </style>\n</head>\n<body>\n  <div class='container'>\n    <div class='header'>\n      <div class='celebration'>üéâ</div>\n      <h1>Ch√∫c m·ª´ng!</h1>\n      <p style='margin: 0; opacity: 0.9;'>B·∫°n ƒë√£ ho√†n th√†nh m·ªôt task!</p>\n    </div>\n    <div class='content'>\n      \n      <div class='completed-task'>\n        <div style='font-size: 24px; margin-bottom: 5px;'>‚úÖ</div>\n        <h2 style='margin: 0; color: #059669;'>{{$json.task_name}}</h2>\n        <p style='margin: 5px 0 0 0; color: #666;'>D·ª± √°n: {{$json.project_name}}</p>\n      </div>\n      \n      <div class='stats-row'>\n        <div class='stat'>\n          <div class='stat-value'>{{$json.completed_count}}</div>\n          <div class='stat-label'>ƒê√£ ho√†n th√†nh</div>\n        </div>\n        <div class='stat'>\n          <div class='stat-value'>{{$json.remaining_count}}</div>\n          <div class='stat-label'>C√≤n l·∫°i</div>\n        </div>\n        <div class='stat'>\n          <div class='stat-value'>{{$json.completion_rate}}%</div>\n          <div class='stat-label'>T·ª∑ l·ªá ho√†n th√†nh</div>\n        </div>\n      </div>\n      \n      <div class='motivation-box'>\n        {{$json.motivation}}\n      </div>\n      \n      <div class='next-tasks'>\n        <div class='section-title'>üìã G·ª£i √Ω tasks ti·∫øp theo</div>\n        <p style='color: #666; font-size: 12px; margin-top: 0;'>S·∫Øp x·∫øp theo ƒë·ªô ∆∞u ti√™n v√† deadline</p>\n        {{$json.next_tasks_html}}\n      </div>\n      \n      <div style='text-align: center; margin-top: 25px;'>\n        <a href='http://localhost:5173/tasks' style='display: inline-block; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 14px 35px; text-decoration: none; border-radius: 25px; font-weight: bold;'>\n          Ti·∫øp t·ª•c l√†m vi·ªác ‚Üí\n        </a>\n      </div>\n      \n      <p style='text-align: center; margin-top: 20px; color: #666;'>\n        M·ªói task ho√†n th√†nh l√† m·ªôt b∆∞·ªõc ti·∫øn! üöÄ\n      </p>\n    </div>\n    <div class='footer'>\n      <p>Email t·ª± ƒë·ªông t·ª´ <strong>AI Deadline Forecasting Agent</strong></p>\n      <p><em>C√¥ng c·ª• qu·∫£n l√Ω deadline C√Å NH√ÇN c·ªßa b·∫°n</em></p>\n    </div>\n  </div>\n</body>\n</html>",
        "options": {}
      },
      "name": "Send Email: Celebration",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [1560, 300],
      "credentials": {
        "smtp": {
          "id": "1",
          "name": "SMTP Account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{$env.BACKEND_API_URL}}/api/webhooks/n8n/automation-log",
        "authentication": "none",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "workflow_name",
              "value": "Task Completion Celebration"
            },
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "input_data",
              "value": "={{JSON.stringify({task_id: $json.task_id, task_name: $json.task_name})}}"
            },
            {
              "name": "output_data",
              "value": "={{JSON.stringify({owner_email: $json.owner_email, completion_rate: $json.completion_rate})}}"
            }
          ]
        },
        "options": {}
      },
      "name": "HTTP: Log to Backend",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{JSON.stringify({success: true, message: 'Celebration email sent', completion_rate: $json.completion_rate})}}",
        "options": {}
      },
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2000, 300]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "HTTP: Get Task Owner Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Get Task Owner Email": {
      "main": [
        [
          {
            "node": "HTTP: Get All Tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Get All Tasks": {
      "main": [
        [
          {
            "node": "Function: Prepare Celebration Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function: Prepare Celebration Data": {
      "main": [
        [
          {
            "node": "IF: Has Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Has Email": {
      "main": [
        [
          {
            "node": "Function: Format Email Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function: Format Email Content": {
      "main": [
        [
          {
            "node": "Send Email: Celebration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email: Celebration": {
      "main": [
        [
          {
            "node": "HTTP: Log to Backend",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Log to Backend": {
      "main": [
        [
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "versionId": "10",
  "id": "10",
  "meta": {
    "instanceId": "ai_deadline_n8n"
  },
  "tags": []
}
