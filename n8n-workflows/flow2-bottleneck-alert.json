{
  "name": "Flow 2 - Bottleneck Alert",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 2
            }
          ]
        }
      },
      "name": "Cron Trigger (Every 2 minutes)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "url": "={{$env.BACKEND_API_URL}}/api/webhooks/n8n/tasks",
        "authentication": "none",
        "options": {}
      },
      "name": "HTTP: Get In Progress Tasks",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [460, 300]
    },
    {
      "parameters": {
        "functionCode": "// Filter stale tasks (no progress update in last 2 minutes)\n// Group by owner_id to send personalized emails\nconst response = $input.first().json;\nconst tasks = response.tasks || [];\nconst now = new Date();\nconst twoMinutesAgo = new Date(now - 2 * 60 * 1000);\n\n// Group stale tasks by owner_id\nconst ownerTasksMap = new Map();\n\nfor (const t of tasks) {\n  // Only check in_progress tasks\n  if (t.status !== 'in_progress') continue;\n  \n  let isStale = false;\n  \n  // Check if last_progress_update is older than 2 minutes\n  if (t.last_progress_update) {\n    const lastUpdate = new Date(t.last_progress_update);\n    if (lastUpdate < twoMinutesAgo) {\n      isStale = true;\n    }\n  } else {\n    // If no last_progress_update, consider it stale\n    isStale = true;\n  }\n  \n  if (isStale && t.owner_id) {\n    if (!ownerTasksMap.has(t.owner_id)) {\n      ownerTasksMap.set(t.owner_id, {\n        owner_id: t.owner_id,\n        owner_name: t.owner_name || 'User',\n        tasks: []\n      });\n    }\n    \n    ownerTasksMap.get(t.owner_id).tasks.push({\n      id: t.id,\n      name: t.name,\n      progress: t.progress || 0,\n      deadline: t.deadline,\n      status: t.status,\n      priority: t.priority,\n      last_progress_update: t.last_progress_update || 'Never',\n      project_id: t.project_id,\n      project_name: t.project_name\n    });\n  }\n}\n\nif (ownerTasksMap.size === 0) {\n  return [];\n}\n\n// Return each owner's data as separate item for parallel processing\nconst ownerDataArray = Array.from(ownerTasksMap.values());\nreturn ownerDataArray.map(ownerData => ({ json: ownerData }));"
      },
      "name": "Function: Filter and Group by Owner",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "url": "={{$env.BACKEND_API_URL}}/api/webhooks/n8n/user-email/{{$json.owner_id}}",
        "authentication": "none",
        "options": {}
      },
      "name": "HTTP: Get Owner Email",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [900, 300]
    },
    {
      "parameters": {
        "functionCode": "// Merge owner email with task data\nconst emailData = $input.first().json;\nconst ownerTaskData = $node['Function: Filter and Group by Owner'].json;\n\n// Build HTML list of stale tasks\nlet tasksHtml = '';\nfor (const task of ownerTaskData.tasks) {\n  tasksHtml += '<li><strong>' + task.name + '</strong> - Ti·∫øn ƒë·ªô: ' + (task.progress || 0) + '% - D·ª± √°n: ' + (task.project_name || 'N/A') + '</li>';\n}\n\nreturn {\n  json: {\n    owner_email: emailData.owner_email,\n    owner_name: emailData.owner_name || ownerTaskData.owner_name,\n    task_count: ownerTaskData.tasks.length,\n    tasks: ownerTaskData.tasks,\n    tasks_html: tasksHtml,\n    project_name: ownerTaskData.tasks[0]?.project_name || 'C√°c d·ª± √°n'\n  }\n};"
      },
      "name": "Function: Prepare Email Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.owner_email}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "name": "IF: Has Owner Email",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "fromEmail": "={{$env.EMAIL_FROM}}",
        "toEmail": "={{$json.owner_email}}",
        "subject": "‚è∞ Nh·∫Øc nh·ªü c√° nh√¢n: Tasks c·ªßa b·∫°n c·∫ßn c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô",
        "emailType": "html",
        "text": "=Xin ch√†o {{$json.owner_name}},\n\nH·ªá th·ªëng ph√°t hi·ªán c√°c tasks C√Å NH√ÇN c·ªßa b·∫°n ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô trong 2 ph√∫t qua.\n\nüìã Tasks c·ªßa b·∫°n c·∫ßn ch√∫ √Ω ({{$json.task_count}} tasks):\n\nüí° G·ª£i √Ω h√†nh ƒë·ªông:\n‚úÖ C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô c√°c tasks c·ªßa b·∫°n\nüîç Ki·ªÉm tra xem c√≥ v∆∞·ªõng m·∫Øc n√†o c·∫ßn gi·∫£i quy·∫øt\n‚è∞ ƒêi·ªÅu ch·ªânh deadline n·∫øu th·ª±c s·ª± c·∫ßn thi·∫øt\nÔøΩÔøΩ Ghi ch√∫ nh·ªØng kh√≥ khƒÉn ƒëang g·∫∑p ph·∫£i\n\nC·∫≠p nh·∫≠t Tasks ngay: http://localhost:5173/tasks\n\n---\nEmail nh·∫Øc nh·ªü t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng AI Deadline Forecasting Agent",
        "html": "=<html><head><style>body{font-family:Arial,sans-serif;line-height:1.6;color:#333}.container{max-width:600px;margin:0 auto;padding:20px;background:#f9f9f9}.header{background:#3b82f6;color:white;padding:20px;text-align:center;border-radius:5px 5px 0 0}.content{background:white;padding:30px;border-radius:0 0 5px 5px}.alert-box{background:#fef3c7;border-left:4px solid #f59e0b;padding:15px;margin:15px 0}.info-box{background:#f0f9ff;border-left:4px solid #0ea5e9;padding:15px;margin:15px 0}.task-list{background:#f9fafb;padding:15px;border-radius:5px;margin:10px 0}</style></head><body><div class='container'><div class='header'><h2>‚è∞ NH·∫ÆC NH·ªû C·∫¨P NH·∫¨T TASKS C√Å NH√ÇN</h2></div><div class='content'><p>Xin ch√†o <strong>{{$json.owner_name}}</strong>,</p><p>H·ªá th·ªëng ph√°t hi·ªán c√°c <strong>tasks C√Å NH√ÇN</strong> c·ªßa b·∫°n ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô trong 2 ph√∫t qua.</p><div class='alert-box'><h3>üìã Tasks c·ªßa b·∫°n c·∫ßn ch√∫ √Ω</h3><p><strong>S·ªë l∆∞·ª£ng tasks:</strong> {{$json.task_count}}</p><div class='task-list'><strong>Danh s√°ch tasks:</strong><ul>{{$json.tasks_html}}</ul></div></div><div class='info-box'><h3>üí° G·ª£i √Ω h√†nh ƒë·ªông</h3><ul><li>‚úÖ C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô c√°c tasks c·ªßa b·∫°n</li><li>üîç Ki·ªÉm tra xem c√≥ v∆∞·ªõng m·∫Øc n√†o c·∫ßn gi·∫£i quy·∫øt</li><li>‚è∞ ƒêi·ªÅu ch·ªânh deadline n·∫øu th·ª±c s·ª± c·∫ßn thi·∫øt</li><li>üìù Ghi ch√∫ nh·ªØng kh√≥ khƒÉn ƒëang g·∫∑p ph·∫£i</li></ul><p><em>üí™ ƒê√¢y l√† tasks C√Å NH√ÇN c·ªßa b·∫°n - b·∫°n l√† ng∆∞·ªùi duy nh·∫•t qu·∫£n l√Ω ch√∫ng!</em></p></div><p style='margin-top:30px;text-align:center'><a href='http://localhost:5173/tasks' style='display:inline-block;background:#3b82f6;color:white;padding:12px 30px;text-decoration:none;border-radius:5px;font-weight:bold'>C·∫≠p nh·∫≠t Tasks ngay</a></p><p style='color:#666;font-size:12px;margin-top:30px;text-align:center'><em>Email nh·∫Øc nh·ªü t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng AI Deadline Forecasting Agent</em><br><em>C√¥ng c·ª• qu·∫£n l√Ω deadline c√° nh√¢n c·ªßa b·∫°n</em></p></div></div></body></html>",
        "options": {}
      },
      "name": "Send Email: Alert to Owner",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [1560, 300],
      "credentials": {
        "smtp": {
          "id": "1",
          "name": "SMTP Account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{$env.BACKEND_API_URL}}/api/webhooks/n8n/automation-log",
        "authentication": "none",
        "method": "POST",
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "={\n  \"workflow_name\": \"Bottleneck Alert\",\n  \"status\": \"success\",\n  \"input_data\": {{JSON.stringify({owner_email: $json.owner_email, task_count: $json.task_count})}},\n  \"output_data\": {{JSON.stringify({email_sent: true})}}\n}",
        "options": {}
      },
      "name": "HTTP: Log to Backend",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1780, 300]
    }
  ],
  "connections": {
    "Cron Trigger (Every 2 minutes)": {
      "main": [
        [
          {
            "node": "HTTP: Get In Progress Tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Get In Progress Tasks": {
      "main": [
        [
          {
            "node": "Function: Filter and Group by Owner",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function: Filter and Group by Owner": {
      "main": [
        [
          {
            "node": "HTTP: Get Owner Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Get Owner Email": {
      "main": [
        [
          {
            "node": "Function: Prepare Email Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function: Prepare Email Data": {
      "main": [
        [
          {
            "node": "IF: Has Owner Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Has Owner Email": {
      "main": [
        [
          {
            "node": "Send Email: Alert to Owner",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email: Alert to Owner": {
      "main": [
        [
          {
            "node": "HTTP: Log to Backend",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "versionId": "2",
  "id": "2",
  "meta": {
    "instanceId": "ai_deadline_n8n"
  },
  "tags": []
}