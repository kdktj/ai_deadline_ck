{
  "name": "Flow 2 - Bottleneck Alert",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 2
            }
          ]
        }
      },
      "name": "Cron Trigger (Every 2 minutes)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "url": "={{$env.BACKEND_API_URL}}/api/webhooks/n8n/tasks",
        "authentication": "none",
        "options": {}
      },
      "name": "HTTP: Get In Progress Tasks",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [460, 300]
    },
    {
      "parameters": {
        "functionCode": "// Filter stale tasks (no progress update in last 2 minutes)\nconst response = $input.first().json;\nconst tasks = response.tasks || [];\nconst staleTasks = [];\nconst now = new Date();\nconst twoMinutesAgo = new Date(now - 2 * 60 * 1000);\n\nfor (const t of tasks) {\n  // Only check in_progress tasks\n  if (t.status !== 'in_progress') continue;\n  \n  // Check if last_progress_update is older than 2 minutes\n  if (t.last_progress_update) {\n    const lastUpdate = new Date(t.last_progress_update);\n    if (lastUpdate < twoMinutesAgo) {\n      staleTasks.push({\n        id: t.id,\n        name: t.name,\n        progress: t.progress || 0,\n        deadline: t.deadline,\n        status: t.status,\n        priority: t.priority,\n        last_progress_update: t.last_progress_update,\n        project_id: t.project_id,\n        project_name: t.project_name,\n        owner_name: t.owner_name\n      });\n    }\n  } else {\n    // If no last_progress_update, consider it stale\n    staleTasks.push({\n      id: t.id,\n      name: t.name,\n      progress: t.progress || 0,\n      deadline: t.deadline,\n      status: t.status,\n      priority: t.priority,\n      last_progress_update: 'Never',\n      project_id: t.project_id,\n      project_name: t.project_name,\n      owner_name: t.owner_name\n    });\n  }\n}\n\nif (staleTasks.length === 0) {\n  return [];\n}\n\nreturn {\n  json: {\n    staleTasks: staleTasks,\n    count: staleTasks.length\n  }\n};"
      },
      "name": "Function: Filter Stale Tasks",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json.count}}",
              "operation": "larger",
              "value2": 0
            }
          ]
        }
      },
      "name": "IF: Has Stale Tasks",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "functionCode": "// Prepare Gemini prompt for bottleneck analysis\n// Nh·∫•n m·∫°nh: ƒê√¢y l√† tasks C√Å NH√ÇN, kh√¥ng ph·∫£i team collaboration\nconst staleTasks = $json.staleTasks;\n\nconst prompt = `B·∫°n ƒëang h·ªó tr·ª£ m·ªôt c√¥ng c·ª• qu·∫£n l√Ω deadline C√Å NH√ÇN.\n\nC√°c task sau ƒë√¢y KH√îNG ƒë∆∞·ª£c c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô trong >2 ph√∫t.\nƒê√¢y l√† tasks C√Å NH√ÇN c·ªßa t·ª´ng user - h·ªç c·∫ßn ƒë∆∞·ª£c nh·∫Øc nh·ªü m·ªôt c√°ch th√¢n thi·ªán:\n\n${JSON.stringify(staleTasks, null, 2)}\n\nPh√¢n t√≠ch b·∫±ng ti·∫øng Vi·ªát v·ªõi tone th√¢n thi·ªán, h·ªó tr·ª£ (KH√îNG d√πng tone c·∫£nh b√°o nghi√™m kh·∫Øc):\n\n1. **Nguy√™n nh√¢n kh·∫£ dƒ©:** T·∫°i sao task c√≥ th·ªÉ b·ªã \"qu√™n\" c·∫≠p nh·∫≠t?\n   - C√≥ th·ªÉ do b·∫≠n c√¥ng vi·ªác kh√°c\n   - C√≥ th·ªÉ g·∫∑p kh√≥ khƒÉn k·ªπ thu·∫≠t\n   - C√≥ th·ªÉ ƒëang ch·ªù th√¥ng tin t·ª´ b√™n ngo√†i\n\n2. **T√°c ƒë·ªông c√° nh√¢n:** Vi·ªác kh√¥ng c·∫≠p nh·∫≠t ·∫£nh h∆∞·ªüng g√¨ ƒë·∫øn deadline c·ªßa ch√≠nh h·ªç?\n\n3. **G·ª£i √Ω h·ªó tr·ª£:** (3-5 ƒëi·ªÉm c·ª• th·ªÉ, tone ƒë·ªông vi√™n)\n   - Chia nh·ªè task n·∫øu qu√° l·ªõn\n   - Ghi ch√∫ v∆∞·ªõng m·∫Øc ƒë·ªÉ gi·∫£i quy·∫øt sau\n   - C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô ngay c·∫£ khi nh·ªè\n   - ...\n\nL∆∞u √Ω: ƒê√¢y l√† C√îNG C·ª§ C√Å NH√ÇN, kh√¥ng ph·∫£i qu·∫£n l√Ω team. H√£y vi·∫øt nh∆∞ m·ªôt tr·ª£ l√Ω AI th√¢n thi·ªán ƒëang nh·∫Øc nh·ªü ch·ªß nh√¢n v·ªÅ c√¥ng vi·ªác c·ªßa ch√≠nh h·ªç.\n\nTr·∫£ l·ªùi ng·∫Øn g·ªçn (200-300 t·ª´), s√∫c t√≠ch, d·ªÖ hi·ªÉu, tone t√≠ch c·ª±c.`;\n\nreturn {\n  json: {\n    prompt: prompt,\n    staleTasks: staleTasks\n  }\n};"
      },
      "name": "Function: Prepare Gemini Prompt",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key={{$env.GEMINI_API_KEY}}",
        "authentication": "none",
        "method": "POST",
        "sendBody": true,
        "contentType": "json",
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [\n    {\n      \"parts\": [\n        {\n          \"text\": {{JSON.stringify($json.prompt)}}\n        }\n      ]\n    }\n  ]\n}",
        "options": {
          "retry": {
            "values": {
              "maxTries": 3,
              "retryOnStatusCodes": {
                "values": [
                  {
                    "statusCode": "429,500,502,503,504"
                  }
                ]
              },
              "waitBetweenTries": 2000
            }
          },
          "timeout": 60000
        }
      },
      "name": "HTTP: Gemini API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1340, 200]
    },
    {
      "parameters": {
        "functionCode": "// Parse AI analysis\nconst response = $input.first().json;\nlet analysis = 'Kh√¥ng th·ªÉ ph√¢n t√≠ch bottleneck';\n\ntry {\n  const text = response.candidates[0].content.parts[0].text;\n  analysis = text;\n} catch (error) {\n  console.log('Error parsing AI response:', error);\n}\n\nreturn {\n  json: {\n    analysis: analysis,\n    staleTasks: $node['Function: Prepare Gemini Prompt'].json.staleTasks\n  }\n};"
      },
      "name": "Function: Parse AI Analysis",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1560, 200]
    },
    {
      "parameters": {
        "url": "={{$env.BACKEND_API_URL}}/api/webhooks/n8n/automation-log",
        "authentication": "none",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "workflow_name",
              "value": "Bottleneck Alert"
            },
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "input_data",
              "value": "={{JSON.stringify($json.staleTasks)}}"
            },
            {
              "name": "output_data",
              "value": "={{JSON.stringify({analysis: $json.analysis})}}"
            }
          ]
        },
        "options": {}
      },
      "name": "HTTP: Log to Backend",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1780, 200]
    },
    {
      "parameters": {
        "functionCode": "// Prepare email recipients - group tasks by project owner\n// M·ªói owner ch·ªâ nh·∫≠n email v·ªÅ tasks C√Å NH√ÇN c·ªßa m√¨nh\nconst staleTasks = $node['Function: Parse AI Analysis'].json.staleTasks;\nconst analysis = $node['Function: Parse AI Analysis'].json.analysis;\n\n// Group tasks by owner (m·ªói owner ch·ªâ qu·∫£n l√Ω tasks c·ªßa m√¨nh)\nconst ownerMap = new Map();\n\nfor (const task of staleTasks) {\n  const ownerId = task.project_id; // S·ª≠ d·ª•ng project_id ƒë·ªÉ group\n  \n  if (!ownerMap.has(ownerId)) {\n    ownerMap.set(ownerId, {\n      project_id: task.project_id,\n      project_name: task.project_name,\n      owner_name: task.owner_name,\n      tasks: []\n    });\n  }\n  ownerMap.get(ownerId).tasks.push(task);\n}\n\nconst projectDetails = Array.from(ownerMap.values());\n\n// CH·ªà return data cho owner emails (KH√îNG c√≥ admin email)\n// L√Ω do: ƒê√¢y l√† c√¥ng c·ª• qu·∫£n l√Ω deadline C√Å NH√ÇN, kh√¥ng ph·∫£i team tool\nreturn {\n  json: {\n    projectDetails: projectDetails,\n    staleTasks: staleTasks,\n    analysis: analysis\n  }\n};"
      },
      "name": "Function: Prepare Email Recipients",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2000, 200]
    },
    {
      "parameters": {
        "functionCode": "// Extract project details array for iteration\nconst projectDetails = $json.projectDetails;\n\n// Return each project as separate item for Split Into Items node\nreturn projectDetails.map(pd => ({\n  json: {\n    project_id: pd.project_id,\n    project_name: pd.project_name,\n    owner_name: pd.owner_name,\n    tasks: pd.tasks,\n    analysis: $json.analysis,\n    adminEmail: $json.adminEmail\n  }\n}));"
      },
      "name": "Function: Extract Projects for Loop",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2000, 100]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "name": "Split Into Items",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [2220, 200]
    },
    {
      "parameters": {
        "url": "={{$env.BACKEND_API_URL}}/api/webhooks/n8n/project-owner-email/{{$json.project_id}}",
        "authentication": "none",
        "options": {}
      },
      "name": "HTTP: Get Project Owner Email",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [2440, 200]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.owner_email}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "name": "IF: Has Owner Email",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2660, 200]
    },
    {
      "parameters": {
        "functionCode": "// Format tasks list as HTML for email\nconst ownerData = $input.first().json;\nconst previousNode = $node['Split Into Items'].json;\n\n// Get tasks for this project from the earlier node\nconst tasks = previousNode.tasks || [];\n\n// Build HTML list of tasks\nlet tasksHtml = '';\nfor (const task of tasks) {\n  tasksHtml += `<li><strong>${task.name}</strong> - Ti·∫øn ƒë·ªô: ${task.progress || 0}%</li>`;\n}\n\nreturn {\n  json: {\n    owner_email: ownerData.owner_email,\n    owner_name: ownerData.owner_name,\n    project_name: ownerData.project_name,\n    project_id: ownerData.project_id,\n    task_count: tasks.length,\n    tasks_html: tasksHtml\n  }\n};"
      },
      "name": "Function: Format Email Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2880, 200]
    },
    {
      "parameters": {
        "fromEmail": "={{$env.EMAIL_FROM}}",
        "toEmail": "={{$json.owner_email}}",
        "subject": "‚è∞ Nh·∫Øc nh·ªü c√° nh√¢n: Tasks c·ªßa b·∫°n c·∫ßn c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô",
        "emailType": "html",
        "text": "=Xin ch√†o {{$json.owner_name}},\n\nH·ªá th·ªëng ph√°t hi·ªán c√°c tasks C√Å NH√ÇN c·ªßa b·∫°n trong d·ª± √°n {{$json.project_name}} ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô trong 2 ph√∫t qua.\n\nüìã Tasks c·ªßa b·∫°n c·∫ßn ch√∫ √Ω:\n- D·ª± √°n: {{$json.project_name}}\n- S·ªë l∆∞·ª£ng tasks: {{$json.task_count}}\n\nüí° G·ª£i √Ω h√†nh ƒë·ªông:\nVui l√≤ng:\n‚úÖ C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô c√°c tasks c·ªßa b·∫°n\nüîç Ki·ªÉm tra xem c√≥ v∆∞·ªõng m·∫Øc n√†o c·∫ßn gi·∫£i quy·∫øt\n‚è∞ ƒêi·ªÅu ch·ªânh deadline n·∫øu th·ª±c s·ª± c·∫ßn thi·∫øt\nüìù Ghi ch√∫ nh·ªØng kh√≥ khƒÉn ƒëang g·∫∑p ph·∫£i\n\nüí™ ƒê√¢y l√† tasks C√Å NH√ÇN c·ªßa b·∫°n - b·∫°n l√† ng∆∞·ªùi duy nh·∫•t qu·∫£n l√Ω ch√∫ng. H√£y c·∫≠p nh·∫≠t ƒë·ªÉ theo d√µi ti·∫øn ƒë·ªô t·ªët h∆°n!\n\nC·∫≠p nh·∫≠t Tasks ngay: http://localhost:5173/projects/{{$json.project_id}}\n\n---\nEmail nh·∫Øc nh·ªü t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng AI Deadline Forecasting Agent\nC√¥ng c·ª• qu·∫£n l√Ω deadline c√° nh√¢n c·ªßa b·∫°n",
        "html": "=<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; background: #f9f9f9; }\n    .header { background: #3b82f6; color: white; padding: 20px; text-align: center; border-radius: 5px 5px 0 0; }\n    .content { background: white; padding: 30px; border-radius: 0 0 5px 5px; }\n    .alert-box { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin: 15px 0; }\n    .info-box { background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 15px; margin: 15px 0; }\n    .task-list { background: #f9fafb; padding: 15px; border-radius: 5px; margin: 10px 0; }\n  </style>\n</head>\n<body>\n  <div class='container'>\n    <div class='header'>\n      <h2>‚è∞ NH·∫ÆC NH·ªû C·∫¨P NH·∫¨T TASKS C√Å NH√ÇN</h2>\n    </div>\n    <div class='content'>\n      <p>Xin ch√†o <strong>{{$json.owner_name}}</strong>,</p>\n      <p>H·ªá th·ªëng ph√°t hi·ªán c√°c <strong>tasks C√Å NH√ÇN</strong> c·ªßa b·∫°n trong d·ª± √°n <strong>{{$json.project_name}}</strong> ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô trong 2 ph√∫t qua.</p>\n      \n      <div class='alert-box'>\n        <h3>üìã Tasks c·ªßa b·∫°n c·∫ßn ch√∫ √Ω</h3>\n        <ul>\n          <li><strong>D·ª± √°n:</strong> {{$json.project_name}}</li>\n          <li><strong>S·ªë l∆∞·ª£ng tasks:</strong> {{$json.task_count}}</li>\n        </ul>\n        \n        <div class='task-list'>\n          <strong>Danh s√°ch tasks:</strong>\n          <ul>\n            {{$json.tasks_html}}\n          </ul>\n        </div>\n      </div>\n      \n      <div class='info-box'>\n        <h3>üí° G·ª£i √Ω h√†nh ƒë·ªông</h3>\n        <p>Vui l√≤ng:</p>\n        <ul>\n          <li>‚úÖ C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô c√°c tasks c·ªßa b·∫°n</li>\n          <li>üîç Ki·ªÉm tra xem c√≥ v∆∞·ªõng m·∫Øc n√†o c·∫ßn gi·∫£i quy·∫øt</li>\n          <li>‚è∞ ƒêi·ªÅu ch·ªânh deadline n·∫øu th·ª±c s·ª± c·∫ßn thi·∫øt</li>\n          <li>üìù Ghi ch√∫ nh·ªØng kh√≥ khƒÉn ƒëang g·∫∑p ph·∫£i</li>\n        </ul>\n        <p><em>üí™ ƒê√¢y l√† tasks C√Å NH√ÇN c·ªßa b·∫°n - b·∫°n l√† ng∆∞·ªùi duy nh·∫•t qu·∫£n l√Ω ch√∫ng. H√£y c·∫≠p nh·∫≠t ƒë·ªÉ theo d√µi ti·∫øn ƒë·ªô t·ªët h∆°n!</em></p>\n      </div>\n      \n      <p style='margin-top: 30px; text-align: center;'>\n        <a href='http://localhost:5173/projects/{{$json.project_id}}' style='display: inline-block; background: #3b82f6; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;'>\n          C·∫≠p nh·∫≠t Tasks ngay ‚Üí\n        </a>\n      </p>\n      \n      <p style='color: #666; font-size: 12px; margin-top: 30px; text-align: center;'>\n        <em>Email nh·∫Øc nh·ªü t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng AI Deadline Forecasting Agent</em><br>\n        <em>C√¥ng c·ª• qu·∫£n l√Ω deadline c√° nh√¢n c·ªßa b·∫°n</em>\n      </p>\n    </div>\n  </div>\n</body>\n</html>",
        "options": {}
      },
      "name": "Send Email: Alert to Project Owner",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [2880, 100],
      "credentials": {
        "smtp": {
          "id": "1",
          "name": "SMTP Account"
        }
      }
    }
  ],
  "connections": {
    "Cron Trigger (Every 2 minutes)": {
      "main": [
        [
          {
            "node": "HTTP: Get In Progress Tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Get In Progress Tasks": {
      "main": [
        [
          {
            "node": "Function: Filter Stale Tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function: Filter Stale Tasks": {
      "main": [
        [
          {
            "node": "IF: Has Stale Tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Has Stale Tasks": {
      "main": [
        [
          {
            "node": "Function: Prepare Gemini Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function: Prepare Gemini Prompt": {
      "main": [
        [
          {
            "node": "HTTP: Gemini API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Gemini API": {
      "main": [
        [
          {
            "node": "Function: Parse AI Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function: Parse AI Analysis": {
      "main": [
        [
          {
            "node": "HTTP: Log to Backend",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Log to Backend": {
      "main": [
        [
          {
            "node": "Function: Prepare Email Recipients",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function: Prepare Email Recipients": {
      "main": [
        [
          {
            "node": "Function: Extract Projects for Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function: Extract Projects for Loop": {
      "main": [
        [
          {
            "node": "Split Into Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Into Items": {
      "main": [
        [
          {
            "node": "HTTP: Get Project Owner Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Get Project Owner Email": {
      "main": [
        [
          {
            "node": "IF: Has Owner Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Has Owner Email": {
      "main": [
        [
          {
            "node": "Function: Format Email Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function: Format Email Data": {
      "main": [
        [
          {
            "node": "Send Email: Alert to Project Owner",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "versionId": "2",
  "id": "2",
  "meta": {
    "instanceId": "ai_deadline_n8n"
  },
  "tags": []
}
