# =============================================================================
# GITHUB ACTIONS - MAIN CI/CD PIPELINE
# =============================================================================
# Workflow nÃ y tá»± Ä‘á»™ng deploy khi push code lÃªn branch main
# =============================================================================

name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Cho phÃ©p cháº¡y manual
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================================================
  # JOB 1: LINT & TEST BACKEND
  # ===========================================================================
  test-backend:
    name: ðŸ Test Backend
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: ðŸ“¦ Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8

      - name: ðŸ” Lint with flake8
        working-directory: ./backend
        run: |
          # Stop if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true

      - name: âœ… Run tests
        working-directory: ./backend
        run: |
          # Skip tests if no test files exist
          if [ -d "tests" ] && [ "$(ls -A tests)" ]; then
            pytest tests/ -v --cov=app --cov-report=xml
          else
            echo "No tests found, skipping..."
          fi
        continue-on-error: true

  # ===========================================================================
  # JOB 2: LINT & TEST FRONTEND
  # ===========================================================================
  test-frontend:
    name: âš›ï¸ Test Frontend
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ðŸ” Lint
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: true

      - name: ðŸ—ï¸ Build
        working-directory: ./frontend
        env:
          VITE_API_URL: https://api.ai-deadline.io.vn
        run: npm run build

  # ===========================================================================
  # JOB 3: BUILD DOCKER IMAGES
  # ===========================================================================
  build-images:
    name: ðŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ“ Extract metadata for Backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/backend
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: ðŸ³ Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ“ Extract metadata for Frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: ðŸ³ Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          build-args: |
            VITE_API_URL=https://api.ai-deadline.io.vn
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # JOB 4: DEPLOY TO PRODUCTION
  # ===========================================================================
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-images]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Validate Required Secrets
        run: |
          missing_secrets=""
          
          if [ -z "${{ secrets.SERVER_IP }}" ]; then
            missing_secrets="$missing_secrets SERVER_IP"
          fi
          
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            missing_secrets="$missing_secrets SERVER_USER"
          fi
          
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            missing_secrets="$missing_secrets SSH_PRIVATE_KEY"
          fi
          
          if [ -n "$missing_secrets" ]; then
            echo "âŒ ERROR: The following required secrets are missing or empty:"
            echo "$missing_secrets"
            echo ""
            echo "Please add these secrets in GitHub repository settings:"
            echo "Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            echo ""
            echo "Required secrets:"
            echo "  - SERVER_IP: Your VPS/Server IP address (e.g., 34.126.xxx.xxx)"
            echo "  - SERVER_USER: SSH username for the server"
            echo "  - SSH_PRIVATE_KEY: Private SSH key for authentication"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      - name: ðŸ” Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'ENDSSH'
            cd /opt/ai-deadline/ai_deadline_ck
            
            # Pull latest code
            git pull origin main
            
            # Build and restart services (build trá»±c tiáº¿p trÃªn server)
            docker compose -f docker-compose.prod.yml build --no-cache
            docker compose -f docker-compose.prod.yml up -d --force-recreate
            
            # Wait for services to start
            echo "â³ Waiting for services to start..."
            sleep 30
            
            # Health check via docker exec (vÃ¬ port 8000 khÃ´ng expose ra host)
            echo "ðŸ¥ Running health check..."
            for i in 1 2 3 4 5; do
              if docker exec ai_deadline_backend curl -sf http://localhost:8000/health; then
                echo ""
                echo "âœ… Health check passed!"
                break
              fi
              if [ $i -eq 5 ]; then
                echo "âŒ Health check failed after 5 attempts"
                exit 1
              fi
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            done
            
            # Cleanup old images
            docker image prune -f
            
            echo "âœ… Deployment completed successfully!"
          ENDSSH

      - name: ðŸ“¢ Notify n8n Webhook
        if: success()
        run: |
          curl -X POST ${{ secrets.N8N_WEBHOOK_URL }}/webhook/deploy-success \
            -H "Content-Type: application/json" \
            -d '{
              "service": "full-stack",
              "status": "success",
              "commit_sha": "${{ github.sha }}",
              "commit_message": "${{ github.event.head_commit.message }}",
              "deployed_at": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'",
              "deployed_by": "${{ github.actor }}"
            }'
        continue-on-error: true

      - name: âŒ Notify on Failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.N8N_WEBHOOK_URL }}/webhook/deploy-failed \
            -H "Content-Type: application/json" \
            -d '{
              "service": "full-stack",
              "status": "failed",
              "commit_sha": "${{ github.sha }}",
              "error": "Deployment failed - check GitHub Actions logs",
              "failed_at": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }'
        continue-on-error: true

  # ===========================================================================
  # JOB 5: POST-DEPLOYMENT CHECKS
  # ===========================================================================
  post-deploy-checks:
    name: âœ… Post-Deploy Checks
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()

    steps:
      - name: ðŸ¥ Health Check - Frontend
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://ai-deadline.io.vn)
          if [ $response -eq 200 ]; then
            echo "âœ… Frontend is healthy (HTTP $response)"
          else
            echo "âŒ Frontend check failed (HTTP $response)"
            exit 1
          fi

      - name: ðŸ¥ Health Check - Backend API
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://api.ai-deadline.io.vn/health)
          if [ $response -eq 200 ]; then
            echo "âœ… Backend API is healthy (HTTP $response)"
          else
            echo "âŒ Backend API check failed (HTTP $response)"
            exit 1
          fi

      - name: ðŸ¥ Health Check - n8n
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://n8n.ai-deadline.io.vn)
          if [ $response -eq 200 ] || [ $response -eq 302 ]; then
            echo "âœ… n8n is healthy (HTTP $response)"
          else
            echo "âŒ n8n check failed (HTTP $response)"
            exit 1
          fi
        continue-on-error: true

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | https://ai-deadline.io.vn | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend API | https://api.ai-deadline.io.vn | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "| n8n | https://n8n.ai-deadline.io.vn | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
