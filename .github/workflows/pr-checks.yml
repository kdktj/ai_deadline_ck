# =============================================================================
# GITHUB ACTIONS - PULL REQUEST CHECKS
# =============================================================================
# Workflow nÃ y cháº¡y tests khi cÃ³ Pull Request
# =============================================================================

name: ðŸ” PR Checks

on:
  pull_request:
    branches: [main, develop_1, develop_2]
    types: [opened, synchronize, reopened]

jobs:
  # ===========================================================================
  # JOB 1: BACKEND CHECKS
  # ===========================================================================
  backend-checks:
    name: ðŸ Backend Checks
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: ðŸ“¦ Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort

      - name: ðŸ” Check formatting with Black
        working-directory: ./backend
        run: black --check --diff .
        continue-on-error: true

      - name: ðŸ” Check imports with isort
        working-directory: ./backend
        run: isort --check-only --diff .
        continue-on-error: true

      - name: ðŸ” Lint with flake8
        working-directory: ./backend
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: ðŸ“ Check for syntax errors
        working-directory: ./backend
        run: python -m py_compile app/main.py app/config.py

  # ===========================================================================
  # JOB 2: FRONTEND CHECKS
  # ===========================================================================
  frontend-checks:
    name: âš›ï¸ Frontend Checks
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ðŸ” Lint
        working-directory: ./frontend
        run: npm run lint

      - name: ðŸ—ï¸ Build check
        working-directory: ./frontend
        env:
          VITE_API_URL: https://api.ai-deadline.io.vn
        run: npm run build

  # ===========================================================================
  # JOB 3: DOCKER BUILD CHECK
  # ===========================================================================
  docker-build-check:
    name: ðŸ³ Docker Build Check
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ³ Build Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ³ Build Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.prod
          push: false
          build-args: |
            VITE_API_URL=https://api.ai-deadline.io.vn
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # JOB 4: PR SUMMARY
  # ===========================================================================
  pr-summary:
    name: ðŸ“Š PR Summary
    runs-on: ubuntu-latest
    needs: [backend-checks, frontend-checks, docker-build-check]
    if: always()

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ” Pull Request Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.backend-checks.result }}" == "success" ]; then
            echo "| ðŸ Backend Checks | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ Backend Checks | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.frontend-checks.result }}" == "success" ]; then
            echo "| âš›ï¸ Frontend Checks | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| âš›ï¸ Frontend Checks | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.docker-build-check.result }}" == "success" ]; then
            echo "| ðŸ³ Docker Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ³ Docker Build | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**PR Author:** @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`" >> $GITHUB_STEP_SUMMARY
